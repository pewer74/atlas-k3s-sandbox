{
    "name": "Atlas K8s Sandbox (K3s on Codespace)",
    // 使用 dind 映像，它在 Codespace 中對容器化應用程式 (如 K3s) 更友善
    "image": "mcr.microsoft.com/devcontainers/base:ubuntu-22.04",
    
    "features": {
        // 安裝 Docker-in-Docker (dind)
        "ghcr.io/devcontainers/features/docker-in-docker:2": {
            "version": "latest",
            "mobsf": "false" 
        },
        // 安裝 K3s/kubectl
        "ghcr.io/devcontainers/features/kubectl-helm-minikube:1": {
            "version": "latest"
        }
    },

    // *** 最關鍵的自動啟動 K3s 邏輯 ***
    "postCreateCommand": [
        "sudo apt-get update && sudo apt-get install -y curl",
        // 1. 安裝 K3s (不啟用 systemd)
        "curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC='--disable traefik' sh -s -",
        
        // 2. 複製 Kubeconfig 檔案並修正權限
        "mkdir -p $HOME/.kube",
        "sudo cp /etc/rancher/k3s/k3s.yaml $HOME/.kube/config",
        "sudo chown $USER:$USER $HOME/.kube/config",

        // 3. 確保 K3s API 伺服器完全啟動並回應 (最長等待 120 秒)
        "echo '等待 K3s API Server 啟動...'",
        "kubectl wait --for=condition=Ready node --all --timeout=120s"
    ],
    
    "customizations": {
        "vscode": {
            "extensions": [
                "ms-kubernetes-tools.vscode-kubernetes-tools",
                "redhat.vscode-yaml"
            ]
        }
    },
    
    // 設置 Codespace 的規格
    "hostRequirements": {
        "cpus": 4,
        "memory": "8gb",
        "storage": "32gb"
    }
}
