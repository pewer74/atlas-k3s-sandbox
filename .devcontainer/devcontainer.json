{
    "name": "Atlas K8s Sandbox (K3d on Codespace)",
    "image": "mcr.microsoft.com/devcontainers/base:ubuntu-22.04",
    
    "features": {
        // 確保 Docker-in-Docker 存在 (K3d 必須)
        "ghcr.io/devcontainers/features/docker-in-docker:2": {
            "version": "latest",
            "mobsf": "false" 
        },
        // 安裝 kubectl 和 K3d
        "ghcr.io/devcontainers/features/kubectl-helm-minikube:1": {
            "version": "latest",
            "k3d": "latest" // 指定安裝 K3d
        }
    },

    // *** K3d 啟動邏輯 (更可靠) ***
    "postCreateCommand": [
        "echo '--- 啟動 K3d 叢集 (K3s over Docker) ---'",
        // 1. 啟動一個名為 'atlas-k3d' 的 K3d 叢集
        "k3d cluster create atlas-k3d --api-port 6550 --servers 1",

        // 2. 配置 kubectl 使用這個新的叢集
        // K3d 會自動將 kubeconfig 檔案合併到 ~/.kube/config
        
        // 3. 確保 K8s 叢集完全啟動並回應
        "echo '等待 K3d 叢集節點 Ready...'",
        "kubectl wait --for=condition=Ready node --all --timeout=120s"
    ],
    
    "customizations": {
        "vscode": {
            "extensions": [
                "ms-kubernetes-tools.vscode-kubernetes-tools",
                "redhat.vscode-yaml"
            ]
        }
    },
    
    "hostRequirements": {
        "cpus": 4,
        "memory": "8gb",
        "storage": "32gb"
    }
}
